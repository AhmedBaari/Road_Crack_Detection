<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roadcheck by Vantage</title>
    <link rel="manifest" href="./manifest.json">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #000000;
    }
        #video {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
        }
        #recordButton {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.863);
            border: none;
            outline: none;
        }
        #switchCameraButton {
            position: fixed;
            bottom: 40px;
            left: calc(50% + 60px);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #69379773;
            border: none;
            outline: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        #switchCameraButton:hover {
            background-color: white; 
            color: black; 
            border: 2px solid #4CAF50;
        }
        
        .app-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px; /* Adjust this value as per your needs */
            /*background-color: #470c53; /* Change this to your preferred color */
            background: linear-gradient(to right, #1a003b, #2d102e); /* Change these colors to your preferred gradient */
            color: #fff; /* Change this to your preferred color */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000; /* This will ensure the bar stays on top of other elements */
            border-radius: 0 0 10px 10px;
        }

        .app-title {
            margin: 0; /* Remove default margin */
            font-size: 20px; /* Adjust this value as per your needs */
            font-family: Arial, sans-serif; /* Change this to your preferred font */
        }
    </style>


    <!-- update the version number as needed -->
    <script defer src="/__/firebase/10.8.1/firebase-app-compat.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/10.8.1/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/10.8.1/firebase-database-compat.js"></script>
    <script defer src="/__/firebase/10.8.1/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/10.8.1/firebase-functions-compat.js"></script>
    <script defer src="/__/firebase/10.8.1/firebase-messaging-compat.js"></script>
    <script defer src="/__/firebase/10.8.1/firebase-storage-compat.js"></script>
    <script defer src="/__/firebase/10.8.1/firebase-analytics-compat.js"></script>
    <script defer src="/__/firebase/10.8.1/firebase-remote-config-compat.js"></script>
    <script defer src="/__/firebase/10.8.1/firebase-performance-compat.js"></script>
    <!-- 
      initialize the SDK after all desired features are loaded, set useEmulator to false
      to avoid connecting the SDK to running emulators.
    -->
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>
</head>
<body>
    <div class="app-bar">
        <h1 class="app-title">Road Damage Detection</h1>
    </div>
    <video id="video" autoplay></video>
    <button id="recordButton"></button>
    <button id="switchCameraButton">&#8635;</button>

    <script>
        // Service Worker
              if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js');
        });
      }

      // Firebase
        const video = document.getElementById('video');
        const recordButton = document.getElementById('recordButton');
        const switchCameraButton = document.getElementById('switchCameraButton');
        let recording = false;
        let mediaRecorder;
        let stream;
        let useFrontCamera = true;

        function getCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: useFrontCamera ? 'user' : 'environment' } 
            })
            .then(function(s) {
                stream = s;
                video.srcObject = s;
                video.play();
            })
            .catch(function(err) {
                console.log("An error occurred: " + err);
            });
        }

        getCamera();

        switchCameraButton.addEventListener('click', function() {
            useFrontCamera = !useFrontCamera;
            getCamera();
        });

        recordButton.addEventListener('click', function() {
          if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            recordButton.textContent = 'Record';
        } else {
            chunks = [];
            mediaRecorder = new MediaRecorder(video.srcObject);
            mediaRecorder.ondataavailable = function(e) {
                chunks.push(e.data);
                // Call sendFrameToAPI function every 5 seconds
                setTimeout(function() {
                    sendFrameToAPI(e.data);
                }, 2000);
            };
            mediaRecorder.onstop = function() {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const videoUrl = URL.createObjectURL(blob);
                const downloadLink = document.createElement('a');
                downloadLink.href = videoUrl;
                downloadLink.download = 'recorded_video.webm';
                downloadLink.click();
            };
            mediaRecorder.start();
            recordButton.textContent = 'Stop';
        }
        });

        function sendFrameToAPI(frame) {
            // Code to send frame to API
        }
        
        function saveFrame() {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const frameUrl = canvas.toDataURL('image/png');
            const downloadLink = document.createElement('a');
            downloadLink.href = frameUrl;
            downloadLink.download = 'frame.png';
            downloadLink.click();
        }
        
        setInterval(saveFrame, 10000); // Save frame every 2 seconds



        /* PWA INSTALL PROMPT */ 
        
    </script>
</body>
</html>